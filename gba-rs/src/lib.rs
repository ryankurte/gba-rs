#![feature(lang_items)]
#![feature(used)]
#![no_std]

use core::ptr;

#[lang = "panic_fmt"]
unsafe extern "C" fn panic_fmt(
    _args: core::fmt::Arguments,
    _file: &'static str,
    _line: u32,
    _col: u32,
) -> ! {
    loop {}
}

#[lang = "start"]
extern "C" fn start<T>(user_main: fn() -> T, _argc: isize, _argv: *const *const u8) -> isize
where
    T: Termination,
{
    user_main().report() as isize
}

#[lang = "termination"]
trait Termination {
    fn report(self) -> i32;
}

impl Termination for () {
    fn report(self) -> i32 {
        0
    }
}

// Reset handler
#[no_mangle]
pub unsafe extern "C" fn reset() -> ! {
    extern "C" {
        fn main(argc: isize, argv: *const *const u8) -> isize;
    }

    main(0, ptr::null());

    loop {}
}

#[repr(C, packed)]
struct Header {
    start_code: u32,
    logo: [u8; 0x9C],
    title: [u8; 12],
    game_code: u32,
    maker_code: u16,
    fixed: u8,
    unit_code: u8,
    device_type: u8,
    unused: [u8; 7],
    game_version: u8,
    complement: u8,
    checksum: u16,
    boot_method: u8,   // 0 for ROM boot, 3 for multiplay
    slave_number: u8,  // Slave ID for multiplay boot
    reserved: [u8; 28],
}

#[link_section = ".header.header"]
#[used]
static HEADER: Header = Header {
    start_code: 0xEA00002E,
    logo: [0x24,0xFF,0xAE,0x51,0x69,0x9A,0xA2,0x21,0x3D,0x84,0x82,0x0A,0x84,0xE4,0x09,0xAD,
	0x11,0x24,0x8B,0x98,0xC0,0x81,0x7F,0x21,0xA3,0x52,0xBE,0x19,0x93,0x09,0xCE,0x20,
	0x10,0x46,0x4A,0x4A,0xF8,0x27,0x31,0xEC,0x58,0xC7,0xE8,0x33,0x82,0xE3,0xCE,0xBF,
	0x85,0xF4,0xDF,0x94,0xCE,0x4B,0x09,0xC1,0x94,0x56,0x8A,0xC0,0x13,0x72,0xA7,0xFC,
	0x9F,0x84,0x4D,0x73,0xA3,0xCA,0x9A,0x61,0x58,0x97,0xA3,0x27,0xFC,0x03,0x98,0x76,
	0x23,0x1D,0xC7,0x61,0x03,0x04,0xAE,0x56,0xBF,0x38,0x84,0x00,0x40,0xA7,0x0E,0xFD,
	0xFF,0x52,0xFE,0x03,0x6F,0x95,0x30,0xF1,0x97,0xFB,0xC0,0x85,0x60,0xD6,0x80,0x25,
	0xA9,0x63,0xBE,0x03,0x01,0x4E,0x38,0xE2,0xF9,0xA2,0x34,0xFF,0xBB,0x3E,0x03,0x44,
	0x78,0x00,0x90,0xCB,0x88,0x11,0x3A,0x94,0x65,0xC0,0x7C,0x63,0x87,0xF0,0x3C,0xAF,
	0xD6,0x25,0xE4,0x8B,0x38,0x0A,0xAC,0x72,0x21,0xD4,0xF8,0x07],
    title: [0u8; 12],
    game_code: 0x00000000,
    maker_code: 0x3130,
    fixed: 0x96,
    unit_code: 0x00,
    device_type: 0x80,
    unused: [0u8; 0x07],
    game_version: 0x00,
    complement: 0x00,
    checksum: 0x0000,
    boot_method: 0x00,
    slave_number: 0x00,
    reserved: [0u8; 28],
};

#[link_section = ".header.reset_vector"]
#[used]
static RESET_VECTOR: unsafe extern "C" fn() -> ! = reset;

